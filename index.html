<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>NVIDIA Vocab - Exam Pro</title>
    <style>
        :root {
            --bg-color: #050505;
            --card-bg: #1a1a1a;
            --nvidia-green: #76b852;
            --nvidia-dark: #4a802a;
            --text-main: #ffffff;
            --text-sub: #888;
            --border-color: #333;
            --highlight: #66fcf1;
            --error: #e74c3c;
            --success: #2ecc71;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Segoe UI', Roboto, "Microsoft JhengHei", sans-serif;
            background-color: var(--bg-color);
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text-main);
            overflow: hidden;
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            position: relative;
        }

        /* === é ‚éƒ¨å°èˆª === */
        .top-nav {
            width: 100%;
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            padding: 5px;
            background: #111;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .nav-tab {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            color: #666;
            transition: all 0.3s;
        }
        .nav-tab.active { background: var(--nvidia-green); color: #000; }

        /* === è¦–åœ–å®¹å™¨ === */
        .view-section {
            width: 100%;
            flex: 1;
            display: none; /* é è¨­éš±è— */
            flex-direction: column;
        }
        .view-section.active { display: flex; }

        /* === å­¸ç¿’æ¨¡å¼ (Learn Mode) === */
        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
            color: var(--nvidia-green);
            font-family: monospace;
            border-bottom: 1px solid #333;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        /* è·³è½‰åŠŸèƒ½ */
        .jump-box {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .jump-input {
            width: 60px;
            background: #222;
            border: 1px solid #444;
            color: white;
            padding: 2px 5px;
            border-radius: 4px;
            text-align: center;
        }

        .card-wrapper {
            flex: 1;
            position: relative;
            margin-bottom: 10px;
            min-height: 200px;
        }

        .card {
            background: var(--card-bg);
            width: 100%;
            height: 100%;
            border: 2px solid var(--nvidia-green);
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(118, 184, 82, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            cursor: pointer;
            overflow-y: auto;
            position: relative;
        }
        .card:active { border-color: #fff; }

        .word-en { font-size: 2.5em; font-weight: 800; color: #fff; margin-bottom: 5px; line-height: 1.1; }
        .pos-tag { background: rgba(118, 184, 82, 0.2); color: var(--nvidia-green); padding: 2px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; border: 1px solid var(--nvidia-green); margin-bottom: 10px; }
        
        .content-box { width: 100%; text-align: left; margin-top: 10px; padding: 10px; border-radius: 8px; display: none; }
        .content-box.show { display: block; animation: fadeIn 0.3s; }
        .sent-section { background: rgba(255,255,255,0.05); border-left: 3px solid var(--highlight); }
        .sent-en { font-size: 1.1em; color: #ddd; line-height: 1.4; }
        .highlight { color: var(--highlight); font-weight: bold; text-decoration: underline; }
        .cn-section { border-top: 1px dashed #444; }
        .word-ch { font-size: 1.3em; color: var(--nvidia-green); font-weight: bold; margin-bottom: 5px; }
        .sent-ch { font-size: 1em; color: #aaa; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* === è€ƒè©¦æ¨¡å¼ (Exam Mode) === */
        .exam-setup {
            background: #111;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #333;
            margin-top: 20px;
        }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; color: var(--nvidia-green); margin-bottom: 5px; font-size: 0.9em; font-weight: bold; }
        .form-row { display: flex; gap: 10px; }
        .form-input { 
            flex: 1; 
            background: #222; 
            border: 1px solid #444; 
            color: white; 
            padding: 10px; 
            border-radius: 6px;
            text-align: center;
        }

        .exam-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: var(--card-bg);
            border: 2px solid var(--highlight);
            border-radius: 12px;
            padding: 20px;
            position: relative;
        }

        .exam-question { font-size: 1.5em; margin-bottom: 20px; color: #fff; line-height: 1.4; }
        .exam-input {
            width: 100%;
            padding: 12px;
            font-size: 1.2em;
            text-align: center;
            border-radius: 8px;
            border: 2px solid #555;
            background: #000;
            color: white;
            margin-bottom: 15px;
            outline: none;
        }
        .exam-input:focus { border-color: var(--highlight); }
        .exam-feedback { font-size: 1.2em; font-weight: bold; min-height: 1.5em; margin-bottom: 10px; }
        .feedback-correct { color: var(--success); }
        .feedback-wrong { color: var(--error); }

        /* === æ§åˆ¶é¢æ¿å…±ç”¨ === */
        .controls-panel {
            width: 100%;
            background: #111;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 10px;
            margin-top: auto;
        }

        .row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
        
        button {
            flex: 1;
            background: #222;
            color: #ccc;
            border: 1px solid #444;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.1s;
        }
        button:active { background: #333; transform: translateY(1px); }

        .btn-green { background: var(--nvidia-green); color: #000; border: none; }
        .btn-primary { background: var(--highlight); color: #000; border: none; }
        .btn-danger { border-color: var(--error); color: var(--error); }
        .btn-auto { border: 1px solid var(--highlight); color: var(--highlight); }
        .btn-auto.playing { background: var(--highlight); color: #000; }

        select { flex: 1; background: #222; color: white; border: 1px solid #444; padding: 8px; border-radius: 5px; }
        
        .learned-badge { position: absolute; top: 10px; right: 10px; font-size: 1.5em; display: none; }
        .tap-hint { position: absolute; bottom: 8px; color: #555; font-size: 0.75em; font-family: monospace; }
        
        .progress-bar { width: 100%; height: 4px; background: #333; margin-top: 5px; border-radius: 2px; }
        .progress-fill { height: 100%; background: var(--nvidia-green); width: 0%; transition: width 0.2s; }

        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <div class="top-nav">
            <div class="nav-tab active" onclick="switchView('learn')" id="tab-learn">ğŸ“– å­¸ç¿’æ¨¡å¼</div>
            <div class="nav-tab" onclick="switchView('exam')" id="tab-exam">ğŸ“ è€ƒè©¦æ¨¡å¼</div>
        </div>

        <div id="view-learn" class="view-section active">
            <div class="header-info">
                <div class="jump-box">
                    <span>ID:</span>
                    <input type="number" id="jump-id" class="jump-input" placeholder="Go">
                    <button onclick="jumpToId()" style="padding: 2px 8px; font-size:0.8em;">ğŸš€</button>
                </div>
                <span id="deck-info">ALL</span>
                <span id="counter">0/0</span>
            </div>

            <div class="card-wrapper">
                <div class="card" onclick="stepLogic()">
                    <div class="learned-badge" id="badge-learned">âœ…</div>
                    
                    <div id="part-word">
                        <div class="word-en" id="text-en">LOADING</div>
                        <span class="pos-tag" id="text-pos">...</span>
                    </div>

                    <div id="part-sent" class="content-box sent-section">
                        <div class="sent-en" id="text-sent-en"></div>
                    </div>

                    <div id="part-cn" class="content-box cn-section">
                        <div class="word-ch" id="text-ch"></div>
                        <div class="sent-ch" id="text-sent-ch"></div>
                    </div>
                    <div class="tap-hint" id="hint-text">é»æ“Šé¡¯ç¤ºæ›´å¤š</div>
                </div>
            </div>

            <div class="controls-panel">
                <div class="row">
                    <select id="filter-mode" onchange="applyFilter()" style="flex:1.2">
                        <option value="all">å…¨éƒ¨</option>
                        <option value="unlearned">æœªå­¸æœƒ</option>
                        <option value="learned">å·²å­¸æœƒ</option>
                    </select>
                    <button id="btn-toggle-learned" onclick="toggleLearnedStatus()" style="font-size:0.8em">ğŸ“ æ¨™è¨˜å­¸æœƒ</button>
                </div>
                <div class="row">
                    <select id="audio-mode" onchange="saveConfig()" style="flex:2">
                        <option value="4">è‹±å–®+ä¸­å–®</option>
                        <option value="6" selected>å…¨éƒ¨(å–®+å¥+ä¸­)</option>
                        <option value="1">åƒ…è‹±å–®</option>
                        <option value="2">åƒ…è‹±å¥</option>
                    </select>
                    <select id="audio-rate" onchange="saveConfig()" style="flex:1">
                        <option value="0.8">0.8x</option>
                        <option value="1.0" selected>1.0x</option>
                        <option value="1.2">1.2x</option>
                    </select>
                    <select id="repeat-count" onchange="saveConfig()" style="flex:1">
                        <option value="1">1æ¬¡</option>
                        <option value="2">2æ¬¡</option>
                        <option value="3">3æ¬¡</option>
                    </select>
                </div>
                <div class="row">
                    <button class="btn-green" onclick="playAudio()">ğŸ”Š æ’­æ”¾</button>
                    <button class="btn-auto" id="btn-auto" onclick="toggleAuto()">âš¡ è‡ªå‹•</button>
                </div>
                <div class="row">
                    <button onclick="prevCard()">â®</button>
                    <button onclick="stepLogic()" id="btn-step" style="flex:2; color:var(--nvidia-green);">é¡¯ç¤ºä¾‹å¥</button>
                    <button onclick="nextCard()">â­</button>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="p-bar"></div></div>
                <div class="row" style="margin-top:10px; border-top:1px solid #333; padding-top:5px;">
                    <button onclick="document.getElementById('csv-file').click()">ğŸ“‚ åŒ¯å…¥</button>
                    <button onclick="shuffleData()">ğŸ”€ äº‚åº</button>
                    <button class="btn-danger" onclick="hardReset()">âš ï¸ é‡ç½®</button>
                </div>
            </div>
        </div>

        <div id="view-exam" class="view-section">
            <div id="exam-setup" class="exam-setup">
                <h3 style="color:#fff; text-align:center; margin-top:0;">è€ƒè©¦è¨­å®š</h3>
                <div class="form-group">
                    <label class="form-label">ID ç¯„åœ (Start - End)</label>
                    <div class="form-row">
                        <input type="number" id="exam-start" class="form-input" placeholder="1" value="1">
                        <input type="number" id="exam-end" class="form-input" placeholder="100" value="50">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">è€ƒé¡Œä¾†æº</label>
                    <select id="exam-source" class="form-input">
                        <option value="all">ç¯„åœå…§å…¨éƒ¨</option>
                        <option value="unlearned">ç¯„åœå…§æœªå­¸æœƒ</option>
                        <option value="learned">ç¯„åœå…§å·²å­¸æœƒ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">è€ƒè©¦é¡å‹</label>
                    <select id="exam-type" class="form-input">
                        <option value="word_3x">ğŸ‘‚ è½å¯«å–®å­— (å”¸3æ¬¡)</option>
                        <option value="sentence_fill">ğŸ“ è½å¥å¡«ç©º</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">èªéŸ³é€Ÿåº¦ (è€ƒè©¦ç”¨)</label>
                    <select id="exam-rate" class="form-input">
                        <option value="0.7">0.7x (æ…¢)</option>
                        <option value="0.9">0.9x (ç¨æ…¢)</option>
                        <option value="1.0" selected>1.0x (æ­£å¸¸)</option>
                        <option value="1.2">1.2x (ç¨å¿«)</option>
                        <option value="1.5">1.5x (å¿«)</option>
                    </select>
                </div>
                <button class="btn-green" style="width:100%; padding:15px; font-size:1.2em;" onclick="startExam()">é–‹å§‹è€ƒè©¦ ğŸ”¥</button>
            </div>

            <div id="exam-active" style="display:none; flex:1; flex-direction:column;">
                <div class="header-info">
                    <span id="exam-progress">Q: 1 / 10</span>
                    <span id="exam-score">Score: 0</span>
                </div>
                
                <div class="card-wrapper">
                    <div class="exam-card">
                        <div id="exam-question-area" class="exam-question">
                            ğŸ”Š è½å¯«æ¨¡å¼ï¼šè«‹ä»”ç´°è½...
                        </div>
                        <input type="text" id="exam-input" class="exam-input" placeholder="åœ¨æ­¤è¼¸å…¥ç­”æ¡ˆ" autocomplete="off">
                        <div id="exam-feedback" class="exam-feedback"></div>
                    </div>
                </div>

                <div class="controls-panel">
                    <div class="row">
                        <button class="btn-primary" onclick="playExamAudio()">ğŸ”Š é‡è½é¡Œç›®</button>
                        <button class="btn-green" id="btn-exam-submit" onclick="checkAnswer()">é€å‡ºç­”æ¡ˆ</button>
                        <button class="btn-auto" id="btn-exam-next" onclick="nextQuestion()" style="display:none;">ä¸‹ä¸€é¡Œ â­</button>
                    </div>
                    <div class="row">
                        <button class="btn-danger" onclick="endExam()">âŒ çµæŸè€ƒè©¦</button>
                    </div>
                </div>
            </div>
        </div>

        <input type="file" id="csv-file" accept=".csv" onchange="importCSV(this)">
    </div>

    <script>
        // === å…¨åŸŸè®Šæ•¸ ===
        let allVocab = [];
        let displayDeck = [];
        let learnedSet = new Set();
        let currentIndex = 0;
        let currentStep = 0; // 0:Word, 1:Sent, 2:All
        let isAuto = false;
        let isSpeaking = false;

        // è€ƒè©¦è®Šæ•¸
        let examDeck = [];
        let examIndex = 0;
        let examScore = 0;
        let examType = '';
        let examRate = 1.0;
        let currentQuestion = null;

        // === åˆå§‹åŒ– ===
        function init() {
            try {
                const savedData = localStorage.getItem('nv_vocab');
                const savedLearned = localStorage.getItem('nv_learned');
                
                if (savedData) allVocab = JSON.parse(savedData);
                else allVocab = [{ id: 1, en: "Ready", ch: "æº–å‚™", pos: "n.", enSent: "System ready.", zhSent: "ç³»çµ±å°±ç·’" }];

                if (savedLearned) learnedSet = new Set(JSON.parse(savedLearned));

                loadConfig('audio-mode', 'nv_amode');
                loadConfig('filter-mode', 'nv_filter');
                
                applyFilter(false); 
                
                // æ¢å¾©ä¸Šæ¬¡ç´¢å¼•
                const savedIdx = parseInt(localStorage.getItem('nv_index') || '0');
                if(!isNaN(savedIdx) && savedIdx < displayDeck.length) currentIndex = savedIdx;
                
                renderCard();
            } catch (e) {
                console.error(e);
                localStorage.clear();
                location.reload();
            }
        }

        function loadConfig(id, key) {
            const val = localStorage.getItem(key);
            if(val) document.getElementById(id).value = val;
        }

        function switchView(view) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${view}`).classList.add('active');
            document.getElementById(`tab-${view}`).classList.add('active');
            
            // åœæ­¢ä»»ä½•æ­£åœ¨æ’­æ”¾çš„è²éŸ³
            window.speechSynthesis.cancel();
            isAuto = false;
        }

        // ================= å­¸ç¿’æ¨¡å¼é‚è¼¯ =================

        function applyFilter(reset = true) {
            const mode = document.getElementById('filter-mode').value;
            localStorage.setItem('nv_filter', mode);

            if (mode === 'unlearned') {
                displayDeck = allVocab.filter(v => !learnedSet.has(String(v.id)));
                document.getElementById('deck-info').innerText = "æœªå­¸æœƒ";
            } else if (mode === 'learned') {
                displayDeck = allVocab.filter(v => learnedSet.has(String(v.id)));
                document.getElementById('deck-info').innerText = "å·²å­¸æœƒ";
            } else {
                displayDeck = [...allVocab];
                document.getElementById('deck-info').innerText = "å…¨éƒ¨";
            }

            if (displayDeck.length === 0) displayDeck = [{ id: 0, en: "No Data", ch: "ç„¡è³‡æ–™", pos: "", enSent: "Check filter.", zhSent: "" }];
            
            if (reset) {
                currentIndex = 0;
                currentStep = 0;
                renderCard();
            }
        }

        function renderCard() {
            if (!displayDeck.length) return;
            const v = displayDeck[currentIndex];
            
            document.getElementById('text-en').innerText = v.en;
            document.getElementById('text-pos').innerText = v.pos || '';
            
            // ä¾‹å¥é«˜äº®
            let sentHtml = v.enSent || "";
            if (sentHtml && v.en) {
                const esc = v.en.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                const reg = new RegExp(`(${esc})`, 'gi');
                sentHtml = sentHtml.replace(reg, '<span class="highlight">$1</span>');
            }
            document.getElementById('text-sent-en').innerHTML = sentHtml;
            document.getElementById('text-ch').innerText = v.ch || "";
            document.getElementById('text-sent-ch').innerText = v.zhSent || "";

            // ç‹€æ…‹
            const isLearned = learnedSet.has(String(v.id));
            const btnLearned = document.getElementById('btn-toggle-learned');
            const badge = document.getElementById('badge-learned');
            
            if (isLearned) {
                badge.style.display = 'block';
                btnLearned.innerText = "âœ… å·²å­¸æœƒ";
                btnLearned.style.borderColor = "var(--success)";
                btnLearned.style.color = "var(--success)";
            } else {
                badge.style.display = 'none';
                btnLearned.innerText = "ğŸ“ æ¨™è¨˜å­¸æœƒ";
                btnLearned.style.borderColor = "var(--text-sub)";
                btnLearned.style.color = "var(--text-sub)";
            }

            document.getElementById('counter').innerText = `${currentIndex + 1}/${displayDeck.length}`;
            const pct = ((currentIndex + 1) / displayDeck.length) * 100;
            document.getElementById('p-bar').style.width = `${pct}%`;
            
            localStorage.setItem('nv_index', currentIndex);
            updateVisibility();
        }

        function updateVisibility() {
            const partSent = document.getElementById('part-sent');
            const partCn = document.getElementById('part-cn');
            const btn = document.getElementById('btn-step');
            const hint = document.getElementById('hint-text');

            partSent.classList.remove('show');
            partCn.classList.remove('show');

            if (currentStep === 0) {
                btn.innerText = "é¡¯ç¤ºä¾‹å¥";
                hint.innerText = "TAP TO SHOW SENTENCE";
            } else if (currentStep === 1) {
                partSent.classList.add('show');
                btn.innerText = "é¡¯ç¤ºä¸­æ–‡";
                hint.innerText = "TAP TO SHOW CHINESE";
            } else if (currentStep === 2) {
                partSent.classList.add('show');
                partCn.classList.add('show');
                btn.innerText = "éš±è—å…§å®¹";
                hint.innerText = "TAP TO HIDE";
            }
        }

        function stepLogic() {
            currentStep++;
            if (currentStep > 2) currentStep = 0;
            updateVisibility();
        }

        function nextCard() {
            if (displayDeck.length === 0) return;
            currentIndex = (currentIndex + 1) % displayDeck.length;
            renderCard(); // ä¿æŒ step ç‹€æ…‹
            if (isAuto) playAudio();
        }

        function prevCard() {
            if (displayDeck.length === 0) return;
            currentIndex = (currentIndex - 1 + displayDeck.length) % displayDeck.length;
            renderCard();
        }

        function jumpToId() {
            const targetId = parseInt(document.getElementById('jump-id').value);
            if (isNaN(targetId)) return;
            
            // åœ¨ displayDeck ä¸­å°‹æ‰¾è©² ID
            const foundIndex = displayDeck.findIndex(v => v.id === targetId);
            if (foundIndex !== -1) {
                currentIndex = foundIndex;
                currentStep = 0;
                renderCard();
            } else {
                alert(`ID ${targetId} ä¸åœ¨ç•¶å‰æ¸…å–®ä¸­ (è«‹æª¢æŸ¥ç¯©é¸æ¢ä»¶)`);
            }
        }

        function toggleLearnedStatus() {
            const v = displayDeck[currentIndex];
            if (!v) return;
            const idStr = String(v.id);
            if (learnedSet.has(idStr)) learnedSet.delete(idStr);
            else learnedSet.add(idStr);
            
            localStorage.setItem('nv_learned', JSON.stringify(Array.from(learnedSet)));
            renderCard();
        }

        // ================= èªéŸ³é‚è¼¯ =================

        function playAudio() {
            if (displayDeck.length === 0) return;
            window.speechSynthesis.cancel();
            isSpeaking = true;

            const v = displayDeck[currentIndex];
            const mode = document.getElementById('audio-mode').value;
            const repeat = parseInt(document.getElementById('repeat-count').value);
            const rate = parseFloat(document.getElementById('audio-rate').value);

            let seq = [];
            if (mode=='1') seq.push({t:v.en, l:'en-US'});
            if (mode=='2') seq.push({t:v.enSent, l:'en-US'});
            if (mode=='4') seq.push({t:v.en, l:'en-US'}, {t:v.ch, l:'zh-TW'});
            if (mode=='6') seq.push({t:v.en, l:'en-US'}, {t:v.enSent, l:'en-US'}, {t:v.ch, l:'zh-TW'}, {t:v.zhSent, l:'zh-TW'});

            let fullQueue = [];
            for(let i=0; i<repeat; i++) fullQueue = fullQueue.concat(seq);

            speakQueue(fullQueue, rate);
        }

        function speakQueue(list, rate) {
            if (list.length === 0) {
                isSpeaking = false;
                if (isAuto) setTimeout(() => { if(isAuto) nextCard(); }, 1500);
                return;
            }
            const item = list.shift();
            const u = new SpeechSynthesisUtterance(item.t);
            u.lang = item.l;
            u.rate = rate;
            u.onend = () => setTimeout(() => speakQueue(list, rate), 300);
            window.speechSynthesis.speak(u);
        }

        function toggleAuto() {
            const btn = document.getElementById('btn-auto');
            if (isAuto) {
                isAuto = false;
                window.speechSynthesis.cancel();
                btn.classList.remove('playing');
                btn.innerText = "âš¡ è‡ªå‹•";
            } else {
                isAuto = true;
                btn.classList.add('playing');
                btn.innerText = "ğŸ›‘ åœæ­¢";
                playAudio();
            }
        }

        // ================= è€ƒè©¦æ¨¡å¼é‚è¼¯ =================

        function startExam() {
            const startId = parseInt(document.getElementById('exam-start').value);
            const endId = parseInt(document.getElementById('exam-end').value);
            const source = document.getElementById('exam-source').value;
            examType = document.getElementById('exam-type').value;
            examRate = parseFloat(document.getElementById('exam-rate').value); // ç²å–è€ƒè©¦èªé€Ÿ

            if (isNaN(startId) || isNaN(endId)) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ ID ç¯„åœ");
                return;
            }

            // ç¯©é¸é¡Œåº«
            examDeck = allVocab.filter(v => {
                const inRange = v.id >= startId && v.id <= endId;
                if (!inRange) return false;
                if (source === 'unlearned') return !learnedSet.has(String(v.id));
                if (source === 'learned') return learnedSet.has(String(v.id));
                return true;
            });

            if (examDeck.length === 0) {
                alert("æ­¤ç¯„åœå…§ç„¡ç¬¦åˆæ¢ä»¶çš„å–®å­—ï¼");
                return;
            }

            // äº‚åºé¡Œåº«
            for (let i = examDeck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [examDeck[i], examDeck[j]] = [examDeck[j], examDeck[i]];
            }

            examIndex = 0;
            examScore = 0;
            document.getElementById('exam-setup').style.display = 'none';
            document.getElementById('exam-active').style.display = 'flex';
            
            showQuestion();
        }

        function showQuestion() {
            currentQuestion = examDeck[examIndex];
            const qArea = document.getElementById('exam-question-area');
            const input = document.getElementById('exam-input');
            const feedback = document.getElementById('exam-feedback');
            const btnSubmit = document.getElementById('btn-exam-submit');
            const btnNext = document.getElementById('btn-exam-next');

            document.getElementById('exam-progress').innerText = `Q: ${examIndex + 1} / ${examDeck.length}`;
            document.getElementById('exam-score').innerText = `Score: ${examScore}`;
            
            input.value = '';
            input.disabled = false;
            feedback.innerText = '';
            btnSubmit.style.display = 'block';
            btnNext.style.display = 'none';
            input.focus();

            if (examType === 'word_3x') {
                qArea.innerHTML = `<span style="font-size:3em">ğŸ”Š</span><br>è«‹è½éŸ³æ‹¼å¯«å–®å­—`;
                playExamAudio();
            } else if (examType === 'sentence_fill') {
                // æŒ–ç©ºå–®å­— (ä¸åˆ†å¤§å°å¯«)
                const word = currentQuestion.en;
                const regex = new RegExp(`(${word})`, 'gi');
                const maskedSent = currentQuestion.enSent.replace(regex, '______');
                qArea.innerHTML = maskedSent;
                playExamAudio();
            }
        }

        function playExamAudio() {
            window.speechSynthesis.cancel();
            if (examType === 'word_3x') {
                // å”¸ 3 æ¬¡å–®å­—
                let queue = [];
                for(let i=0; i<3; i++) queue.push({t: currentQuestion.en, l:'en-US'});
                speakQueue(queue, examRate);
            } else if (examType === 'sentence_fill') {
                // å”¸å®Œæ•´å¥å­
                let queue = [{t: currentQuestion.enSent, l:'en-US'}];
                speakQueue(queue, examRate);
            }
        }

        function checkAnswer() {
            const input = document.getElementById('exam-input');
            const feedback = document.getElementById('exam-feedback');
            const btnSubmit = document.getElementById('btn-exam-submit');
            const btnNext = document.getElementById('btn-exam-next');
            
            const userAns = input.value.trim().toLowerCase();
            const correctAns = currentQuestion.en.trim().toLowerCase();

            input.disabled = true;
            btnSubmit.style.display = 'none';
            btnNext.style.display = 'block';

            if (userAns === correctAns) {
                feedback.innerHTML = "âœ… æ­£ç¢ºï¼";
                feedback.className = "exam-feedback feedback-correct";
                examScore += 10;
            } else {
                feedback.innerHTML = `âŒ éŒ¯èª¤<br>ç­”æ¡ˆï¼š<span style="color:var(--nvidia-green)">${currentQuestion.en}</span>`;
                feedback.className = "exam-feedback feedback-wrong";
            }
            
            document.getElementById('exam-score').innerText = `Score: ${examScore}`;
        }

        function nextQuestion() {
            examIndex++;
            if (examIndex < examDeck.length) {
                showQuestion();
            } else {
                alert(`è€ƒè©¦çµæŸï¼\nç¸½åˆ†ï¼š${examScore}\nç­”å°ç‡ï¼š${Math.round((examScore / (examDeck.length * 10)) * 100)}%`);
                endExam();
            }
        }

        function endExam() {
            window.speechSynthesis.cancel();
            document.getElementById('exam-active').style.display = 'none';
            document.getElementById('exam-setup').style.display = 'block';
        }

        // ================= æª”æ¡ˆèˆ‡å·¥å…· =================

        function importCSV(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const lines = text.split('\n');
                const newData = [];
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    const p = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s => s.trim().replace(/^"|"$/g, ''));
                    if (p[0].toLowerCase().includes('id') || p[0].toLowerCase() === 'en') continue;

                    let item = {};
                    if (p.length >= 6 && !isNaN(parseInt(p[0]))) {
                        item = { id: parseInt(p[0]), en: p[1], ch: p[2], pos: p[3], enSent: p[4], zhSent: p[5] };
                    } else if (p.length >= 5) {
                        item = { id: i, en: p[0], ch: p[1], pos: p[2], enSent: p[3], zhSent: p[4] };
                    }
                    if (item.en) newData.push(item);
                }

                if (newData.length > 0) {
                    allVocab = newData;
                    localStorage.setItem('nv_vocab', JSON.stringify(allVocab));
                    applyFilter(true);
                    alert(`åŒ¯å…¥æˆåŠŸï¼å…± ${newData.length} ç­†`);
                } else {
                    alert("åŒ¯å…¥å¤±æ•—");
                }
            };
            reader.readAsText(file);
        }

        function shuffleData() {
            for (let i = allVocab.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allVocab[i], allVocab[j]] = [allVocab[j], allVocab[i]];
            }
            localStorage.setItem('nv_vocab', JSON.stringify(allVocab));
            applyFilter(true);
            alert("é¡Œåº«å·²äº‚åº");
        }

        function hardReset() {
            if (confirm("ç¢ºå®šé‡ç½®ï¼Ÿ")) {
                localStorage.clear();
                location.reload();
            }
        }

        function saveConfig() {
            localStorage.setItem('nv_amode', document.getElementById('audio-mode').value);
        }

        // Enter éµé€å‡ºç­”æ¡ˆ
        document.getElementById('exam-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                if (!this.disabled) checkAnswer();
                else nextQuestion();
            }
        });

        init();
    </script>
</body>
</html>