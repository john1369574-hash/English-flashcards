<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>NVIDIA Vocab - Stable Tech</title>
    <style>
        :root {
            --bg-color: #050505;
            --card-bg: #1a1a1a;
            --nvidia-green: #76b852;
            --nvidia-dark: #5fa33a;
            --text-main: #ffffff;
            --border-color: #333;
            --highlight: #66fcf1;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Segoe UI', Roboto, "Microsoft JhengHei", sans-serif;
            background-color: var(--bg-color);
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 20px 20px;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text-main);
            overflow: hidden;
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }

        /* === é ‚éƒ¨ç‹€æ…‹ === */
        .header-info {
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 10px;
            color: var(--nvidia-green);
            font-family: monospace;
            border-bottom: 1px solid #333;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        /* === å¡ç‰‡å€åŸŸ === */
        .card-wrapper {
            width: 100%;
            flex: 1;
            position: relative;
            margin-bottom: 15px;
            min-height: 300px; /* é˜²æ­¢é«˜åº¦å¡Œé™· */
        }

        .card {
            background: var(--card-bg);
            width: 100%;
            height: 100%;
            border: 2px solid var(--nvidia-green);
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(118, 184, 82, 0.15);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            cursor: pointer;
            overflow-y: auto;
            position: relative;
        }

        .card:active { transform: scale(0.995); border-color: #fff; }

        /* å…§å®¹æ¨£å¼ */
        .word-en { font-size: 2.8em; font-weight: 800; color: #fff; margin-bottom: 10px; line-height: 1.1; }
        .pos-tag { background: rgba(118, 184, 82, 0.2); color: var(--nvidia-green); padding: 4px 8px; border-radius: 4px; font-size: 0.9em; font-weight: bold; border: 1px solid var(--nvidia-green); margin-bottom: 15px; }

        .content-box {
            width: 100%;
            text-align: left;
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            /* é è¨­éš±è— */
            display: none; 
        }

        .content-box.show { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .sent-section { background: rgba(255,255,255,0.05); border-left: 3px solid var(--highlight); }
        .sent-en { font-size: 1.2em; color: #ddd; line-height: 1.4; }
        .highlight { color: var(--highlight); font-weight: bold; text-decoration: underline; }

        .cn-section { border-top: 1px dashed #444; margin-top: 10px; }
        .word-ch { font-size: 1.4em; color: var(--nvidia-green); font-weight: bold; margin-bottom: 5px; }
        .sent-ch { font-size: 1.1em; color: #aaa; }

        .tap-hint { position: absolute; bottom: 10px; color: #555; font-size: 0.8em; font-family: monospace; letter-spacing: 1px; }

        /* === æ§åˆ¶é¢æ¿ === */
        .controls-panel {
            width: 100%;
            background: #111;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 15px;
        }

        .row { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
        .label { font-size: 0.85em; color: #888; white-space: nowrap; min-width: 60px; }

        select {
            flex: 1;
            background: #222;
            color: white;
            border: 1px solid #444;
            padding: 8px;
            border-radius: 5px;
            font-size: 0.95em;
            outline: none;
        }

        button {
            flex: 1;
            background: #222;
            color: #ccc;
            border: 1px solid #444;
            padding: 12px;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.1s;
        }
        button:active { background: #333; color: #fff; }

        /* ç‰¹æ®ŠæŒ‰éˆ•è‰² */
        .btn-green { background: var(--nvidia-green); color: #000; border: none; }
        .btn-green:active { background: var(--nvidia-dark); }
        
        .btn-auto { border: 1px solid var(--highlight); color: var(--highlight); }
        .btn-auto.playing { background: var(--highlight); color: #000; }

        .btn-reset { border: 1px solid #e74c3c; color: #e74c3c; font-size: 0.8em; padding: 8px; }

        input[type="file"] { display: none; }

        /* é€²åº¦æ¢ */
        .progress-bar { width: 100%; height: 4px; background: #333; margin-top: 10px; border-radius: 2px; }
        .progress-fill { height: 100%; background: var(--nvidia-green); width: 0%; transition: width 0.2s; }

    </style>
</head>
<body>

    <div class="container">
        <div class="header-info">
            <span id="status-text">READY</span>
            <span id="count-text">0 / 0</span>
        </div>

        <div class="card-wrapper">
            <div class="card" onclick="stepLogic()">
                
                <div id="part-word">
                    <div class="word-en" id="text-en">LOADING</div>
                    <span class="pos-tag" id="text-pos">...</span>
                </div>

                <div id="part-sent" class="content-box sent-section">
                    <div class="sent-en" id="text-sent-en"></div>
                </div>

                <div id="part-cn" class="content-box cn-section">
                    <div class="word-ch" id="text-ch"></div>
                    <div class="sent-ch" id="text-sent-ch"></div>
                </div>

                <div class="tap-hint" id="hint-text">é»æ“Šé¡¯ç¤ºæ›´å¤š</div>
            </div>
        </div>

        <div class="controls-panel">
            
            <div class="row">
                <span class="label">ç™¼éŸ³æ¨¡å¼</span>
                <select id="audio-mode" onchange="saveConfig()">
                    <option value="1">1. è‹±æ–‡å–®å­—</option>
                    <option value="2">2. è‹±æ–‡ä¾‹å¥</option>
                    <option value="3">3. å–®å­— + ä¾‹å¥</option>
                    <option value="4" selected>4. è‹±å–® + ä¸­å–®</option>
                    <option value="5">5. è‹±å¥ + ä¸­å¥</option>
                    <option value="6">6. å…¨éƒ¨ (å–®+å¥+ä¸­)</option>
                </select>
            </div>

            <div class="row">
                <button class="btn-green" onclick="playAudio()">ğŸ”Š æ’­æ”¾ç™¼éŸ³</button>
                <button class="btn-auto" id="btn-auto" onclick="toggleAuto()">âš¡ è‡ªå‹•æ’­æ”¾</button>
            </div>

            <div class="row">
                <button onclick="prevCard()">â® ä¸Šä¸€å¼µ</button>
                <button onclick="stepLogic()" id="btn-step" style="flex:2; border-color:var(--nvidia-green); color:var(--nvidia-green);">é¡¯ç¤ºä¾‹å¥</button>
                <button onclick="nextCard()">ä¸‹ä¸€å¼µ â­</button>
            </div>

            <div class="progress-bar"><div class="progress-fill" id="p-bar"></div></div>

            <div class="row" style="margin-top:15px; padding-top:10px; border-top:1px solid #333;">
                <button onclick="document.getElementById('csv-file').click()">ğŸ“‚ åŒ¯å…¥ CSV</button>
                <button onclick="shuffleData()">ğŸ”€ äº‚åº</button>
                <button class="btn-reset" onclick="hardReset()">âš ï¸ é‡ç½®ç³»çµ±</button>
            </div>
            <input type="file" id="csv-file" accept=".csv" onchange="importCSV(this)">
        </div>
    </div>

    <script>
        // === 1. åˆå§‹åŒ–è³‡æ–™ ===
        const defaultData = [
            { id: 1, en: "System Ready", ch: "ç³»çµ±å°±ç·’", pos: "Status", enSent: "Please import your vocabulary CSV file.", zhSent: "è«‹åŒ¯å…¥æ‚¨çš„å–®å­— CSV æª”æ¡ˆã€‚" }
        ];

        let vocab = [];
        let index = 0;
        let step = 0; // 0:å–®å­—, 1:ä¾‹å¥, 2:å…¨éƒ¨
        let isAuto = false;
        let isSpeaking = false;

        // === 2. å•Ÿå‹•èˆ‡é˜²å´©æ½° ===
        function init() {
            try {
                const savedData = localStorage.getItem('nv_vocab');
                const savedIndex = localStorage.getItem('nv_index');
                const savedStep = localStorage.getItem('nv_step');
                const savedMode = localStorage.getItem('nv_mode');

                if (savedData && savedData !== "undefined" && savedData !== "[]") {
                    vocab = JSON.parse(savedData);
                    document.getElementById('status-text').textContent = `å·²è¼‰å…¥ ${vocab.length} å–®å­—`;
                } else {
                    vocab = [...defaultData];
                }

                if (savedIndex) index = parseInt(savedIndex);
                if (index >= vocab.length || isNaN(index)) index = 0;

                // æ¢å¾©ä¸Šæ¬¡çš„é¡¯ç¤ºç‹€æ…‹ (é‡è¦ï¼šä¿ç•™æ˜¯å¦é¡¯ç¤ºä¾‹å¥çš„ç‹€æ…‹)
                if (savedStep) step = parseInt(savedStep);

                if (savedMode) document.getElementById('audio-mode').value = savedMode;

                renderCard();
            } catch (e) {
                console.error("Init failed:", e);
                // å‡ºéŒ¯æ™‚è‡ªå‹•é‡ç½®ï¼Œç¢ºä¿æœ‰ç•«é¢
                localStorage.clear();
                vocab = [...defaultData];
                renderCard();
            }
        }

        // === 3. æ ¸å¿ƒæ¸²æŸ“ (æœ€é‡è¦çš„é¡¯ç¤ºéƒ¨åˆ†) ===
        function renderCard() {
            if (!vocab || vocab.length === 0) return;
            const v = vocab[index];

            // 1. å¡«å…¥æ–‡å­—
            document.getElementById('text-en').innerText = v.en;
            document.getElementById('text-pos').innerText = v.pos || '';
            
            // ä¾‹å¥é«˜äº®
            let sentHtml = v.enSent || "";
            if (sentHtml && v.en) {
                const esc = v.en.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                const reg = new RegExp(`(${esc})`, 'gi');
                sentHtml = sentHtml.replace(reg, '<span class="highlight">$1</span>');
            }
            document.getElementById('text-sent-en').innerHTML = sentHtml;
            
            document.getElementById('text-ch').innerText = v.ch || "";
            document.getElementById('text-sent-ch').innerText = v.zhSent || "";

            // 2. æ›´æ–°é€²åº¦æ¢
            document.getElementById('count-text').innerText = `${index + 1} / ${vocab.length}`;
            const pct = ((index + 1) / vocab.length) * 100;
            document.getElementById('p-bar').style.width = `${pct}%`;

            // 3. æ ¹æ“š Step ç‹€æ…‹æ§åˆ¶é¡¯ç¤º
            updateVisibility();

            // 4. å­˜æª”ç‹€æ…‹
            localStorage.setItem('nv_index', index);
            localStorage.setItem('nv_step', step);
        }

        function updateVisibility() {
            const partSent = document.getElementById('part-sent');
            const partCn = document.getElementById('part-cn');
            const btn = document.getElementById('btn-step');
            const hint = document.getElementById('hint-text');

            // å¼·åˆ¶ç§»é™¤ classï¼Œé‡ç½®ç‹€æ…‹
            partSent.classList.remove('show');
            partCn.classList.remove('show');

            if (step === 0) {
                // ç‹€æ…‹ 0: åªé¡¯ç¤ºå–®å­—
                btn.innerText = "é¡¯ç¤ºä¾‹å¥";
                hint.innerText = "é»æ“Šé¡¯ç¤ºä¾‹å¥";
            } else if (step === 1) {
                // ç‹€æ…‹ 1: å–®å­— + ä¾‹å¥
                partSent.classList.add('show');
                btn.innerText = "é¡¯ç¤ºä¸­æ–‡";
                hint.innerText = "é»æ“Šé¡¯ç¤ºä¸­æ–‡";
            } else if (step === 2) {
                // ç‹€æ…‹ 2: å…¨éƒ¨é¡¯ç¤º
                partSent.classList.add('show');
                partCn.classList.add('show');
                btn.innerText = "éš±è—å…§å®¹";
                hint.innerText = "é»æ“Šéš±è—è©³ç´°å…§å®¹";
            }
        }

        // === 4. äº’å‹•é‚è¼¯ (æ ¸å¿ƒéœ€æ±‚) ===
        
        // é»æ“Šå¡ç‰‡æˆ–ä¸­é–“æŒ‰éˆ•ï¼šå¾ªç’°åˆ‡æ›é¡¯ç¤ºï¼Œä¸æ›å¡
        function stepLogic() {
            step++;
            if (step > 2) step = 0; // å¾ªç’°: 0->1->2->0
            updateVisibility();
            localStorage.setItem('nv_step', step);
        }

        // ä¸‹ä¸€å¼µï¼šåˆ‡æ›å¡ç‰‡ï¼Œä½†ä¿ç•™ç•¶å‰çš„é¡¯ç¤ºç‹€æ…‹ (Keep State)
        function nextCard() {
            if (vocab.length === 0) return;
            index = (index + 1) % vocab.length;
            renderCard();
            if (isAuto) playAudio();
        }

        // ä¸Šä¸€å¼µï¼šä¿ç•™ç‹€æ…‹
        function prevCard() {
            if (vocab.length === 0) return;
            index = (index - 1 + vocab.length) % vocab.length;
            renderCard();
        }

        // === 5. ç™¼éŸ³åŠŸèƒ½ ===
        function playAudio() {
            if (vocab.length === 0) return;
            window.speechSynthesis.cancel();
            isSpeaking = true;

            const v = vocab[index];
            const mode = document.getElementById('audio-mode').value;
            let playlist = [];

            // 1:è‹±å–®, 2:è‹±å¥, 3:å…¨è‹±, 4:è‹±ä¸­å–®, 5:è‹±ä¸­å¥, 6:å…¨éƒ¨
            if (mode == '1') playlist.push({t: v.en, l: 'en-US'});
            if (mode == '2') playlist.push({t: v.enSent, l: 'en-US'});
            if (mode == '3') playlist.push({t: v.en, l: 'en-US'}, {t: v.enSent, l: 'en-US'});
            if (mode == '4') playlist.push({t: v.en, l: 'en-US'}, {t: v.ch, l: 'zh-TW'});
            if (mode == '5') playlist.push({t: v.enSent, l: 'en-US'}, {t: v.zhSent, l: 'zh-TW'});
            if (mode == '6') playlist.push({t: v.en, l: 'en-US'}, {t: v.enSent, l: 'en-US'}, {t: v.ch, l: 'zh-TW'}, {t: v.zhSent, l: 'zh-TW'});

            speakQueue(playlist);
        }

        function speakQueue(list) {
            if (list.length === 0) {
                isSpeaking = false;
                if (isAuto) {
                    setTimeout(() => { if(isAuto) nextCard(); }, 2000); // å”¸å®Œç­‰2ç§’
                }
                return;
            }

            const item = list.shift();
            const u = new SpeechSynthesisUtterance(item.t);
            u.lang = item.l;
            u.rate = 1.0;
            
            // ç°¡å–®å®¹éŒ¯ï¼šå¦‚æœæ²’æœ‰ä¸­æ–‡èªéŸ³ï¼Œæœ‰äº›ç€è¦½å™¨æœƒéœéŸ³
            u.onend = () => { setTimeout(() => speakQueue(list), 300); };
            window.speechSynthesis.speak(u);
        }

        function toggleAuto() {
            const btn = document.getElementById('btn-auto');
            if (isAuto) {
                isAuto = false;
                window.speechSynthesis.cancel();
                btn.classList.remove('playing');
                btn.innerText = "âš¡ è‡ªå‹•æ’­æ”¾";
            } else {
                isAuto = true;
                btn.classList.add('playing');
                btn.innerText = "ğŸ›‘ åœæ­¢";
                playAudio();
            }
        }

        // === 6. è³‡æ–™ç®¡ç† ===
        function importCSV(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    const newData = [];
                    
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        // CSV è§£æ Regex (è™•ç†é€—è™Ÿ)
                        const p = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s => s.trim().replace(/^"|"$/g, ''));
                        
                        // è·³éæ¨™é¡Œ
                        if (p[0].toLowerCase().includes('id') || p[0].toLowerCase() === 'en') continue;

                        let item = {};
                        if (p.length >= 6 && !isNaN(parseInt(p[0]))) {
                            item = { id: p[0], en: p[1], ch: p[2], pos: p[3], enSent: p[4], zhSent: p[5] };
                        } else if (p.length >= 5) {
                            item = { id: i, en: p[0], ch: p[1], pos: p[2], enSent: p[3], zhSent: p[4] };
                        }

                        if (item.en) newData.push(item);
                    }

                    if (newData.length > 0) {
                        vocab = newData;
                        index = 0;
                        step = 0;
                        localStorage.setItem('nv_vocab', JSON.stringify(vocab));
                        renderCard();
                        alert(`åŒ¯å…¥æˆåŠŸï¼å…± ${vocab.length} ç­†è³‡æ–™`);
                    } else {
                        alert("åŒ¯å…¥å¤±æ•—ï¼šç„¡æ³•è§£æ CSV å…§å®¹");
                    }
                } catch (err) {
                    alert("åŒ¯å…¥ç™¼ç”ŸéŒ¯èª¤");
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }

        function shuffleData() {
            if (vocab.length < 2) return;
            for (let i = vocab.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [vocab[i], vocab[j]] = [vocab[j], vocab[i]];
            }
            index = 0;
            renderCard();
            alert("å·²éš¨æ©Ÿäº‚åº");
        }

        function hardReset() {
            if (confirm("ç¢ºå®šè¦é‡ç½®ç³»çµ±å—ï¼Ÿé€™æœƒæ¸…é™¤æ‰€æœ‰ç´€éŒ„ã€‚")) {
                localStorage.clear();
                location.reload();
            }
        }

        function saveConfig() {
            localStorage.setItem('nv_mode', document.getElementById('audio-mode').value);
        }

        // å•Ÿå‹•
        init();

    </script>
</body>
</html>